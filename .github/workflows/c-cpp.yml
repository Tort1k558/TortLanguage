name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up MSVC
      uses: microsoft/setup-msbuild@v1.3.1

    - name: Cache LLVM build
      id: cache-llvm
      uses: actions/cache@v3
      with:
        path: llvm/llvmBuild
        key: llvm-build-${{ runner.os }}-msvc-${{ hashFiles('llvm/CMakeLists.txt') }}
    - name: create llvmDir
      run: |
        mkdir llvm
        cd llvm
        
    - name: Clone LLVM repository
      if: steps.cache-llvm.outputs.cache-hit != 'true'
      uses: actions/checkout@v3
      with:
        repository: llvm/llvm-project
        ref: llvmorg-16.0.0

    - name: Build LLVM
      if: steps.cache-llvm.outputs.cache-hit != 'true'
      run: |
        mkdir build
        cd build
        cmake -G "Visual Studio 17 2022" -A x64 -DLLVM_ENABLE_PROJECTS="llvm;lld" ../llvm
        cmake --build . --config Release

    - name: Get llvmBuild path
      if: steps.cache-llvm.outputs.cache-hit != 'true'
      run: |
          mkdir ../../llvmBuild
          cmake -DCMAKE_INSTALL_PREFIX=../../llvmBuild -P cmake_install.cmake
          echo "##[set-env name=LLVMPATH]/llvmBuild;%LLVMPATH%"
